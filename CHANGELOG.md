# 📋 更新日志

## v0.8.3 - Relay连接配置修复和回归测试 (2024-12-18)

### 🔧 重大修复

#### Relay连接配置逻辑修复
- **修复** 单级跳板配置时要求配置两个服务器的问题
- **修正** 二级跳板连接顺序：`本地 → relay-cli → 第一级跳板机 → 最终目标服务器`
- **优化** 配置界面显示，清晰区分单级和二级跳板
- **改进** 编辑配置时的智能架构选择

#### 配置编辑功能增强
- **新增** 智能检测现有配置类型（单级/二级跳板）
- **优化** 编辑流程，自动识别并提供相应配置选项
- **改进** 配置保存逻辑，确保specs结构正确生成
- **增强** 向后兼容性，支持旧配置格式

### 🧪 质量保证

#### 回归测试套件
- **新增** `tests/regression/test_relay_config_fix.py` - 完整的回归测试
- **测试覆盖** 单级跳板配置生成和验证
- **测试覆盖** 二级跳板配置生成和验证
- **测试覆盖** 连接流程顺序正确性
- **测试覆盖** 配置向后兼容性
- **测试覆盖** Docker配置保持完整性

#### 测试用例详情
```python
# 单级跳板测试
test_single_level_relay_config()
# 二级跳板测试  
test_two_level_relay_config()
# 连接顺序测试
test_connection_flow_order()
# 向后兼容测试
test_config_backward_compatibility()
# Docker配置保护测试
test_docker_config_preservation()
```

### 🎯 用户体验改进

#### 配置流程优化
- **简化** 单级跳板配置，只需一步配置目标服务器
- **明确** 二级跳板配置，分步配置第一级跳板机和最终目标
- **清晰** 连接流程说明和可视化指引
- **智能** 默认值设置，基于现有配置智能推荐

#### 错误预防
- **防止** 配置错误的连接顺序
- **避免** 不必要的重复配置步骤
- **确保** 配置结构的一致性和正确性
- **保护** 现有Docker和其他配置不被影响

### 🔍 技术细节

#### 配置结构修正
```yaml
# 单级跳板 (修复后)
specs:
  connection:
    tool: relay-cli
    target: {host: "target-server.com"}

# 二级跳板 (修复后)  
specs:
  connection:
    tool: relay-cli
    target: {host: "first-jump.com"}     # relay-cli连接的第一级
    jump_host: {host: "final-target.com"} # 最终目标服务器
```

#### 编辑逻辑改进
- **智能识别** 基于`jump_host`字段存在性判断配置类型
- **动态调整** 根据选择的架构类型生成对应配置
- **保持兼容** 支持从旧格式平滑迁移到新格式

### 📋 测试验证

#### 测试执行结果
```bash
$ python3 -m pytest tests/regression/test_relay_config_fix.py -v
============================================ 6 passed in 0.90s ============================================
```

#### 覆盖场景
- ✅ 单级跳板配置正确性
- ✅ 二级跳板配置正确性  
- ✅ 连接顺序验证
- ✅ 向后兼容性
- ✅ Docker配置保护
- ✅ 编辑配置类型检测

---

## v0.8.2 - 配置文件保护和NPM发布优化 (2024-12-20)

### 🛡️ 用户配置保护

#### 智能配置管理
- **修复** NPM包更新时可能覆盖用户配置文件的问题
- **新增** 智能配置初始化，仅在用户无配置文件时创建默认配置
- **移除** config/目录从NPM包files列表，避免意外覆盖
- **优化** postinstall脚本，增加配置文件安全检查

#### 用户体验改进
- **保护** 现有用户的config.yaml文件不被覆盖
- **创建** 默认配置文件到用户目录 `~/.remote-terminal-mcp/config.yaml`
- **静默处理** 配置初始化失败，不影响包安装
- **提供** 配置文件创建指引和文档链接

### 📦 NPM发布优化

#### 包内容精简
- **移除** 不必要的配置文件，减少包大小
- **保留** 核心功能文件和文档
- **优化** 文件包含列表，提高安装速度

---

## v0.8.1 - 自动化二级跳转和密码认证优化 (2024-12-20)

### 🔧 核心修复

#### 自动化二级跳转逻辑修复
- **修复** relay连接中的自动二级跳转功能
- **优化** SSH命令构建，确保用户名正确传递到目标服务器 
- **增强** 连接流程，实现真正的自动化多级跳转
- **改进** 配置传递逻辑，支持复杂的网络拓扑结构

#### 密码认证支持增强
- **新增** `password` 字段支持到 `ServerConfig` 数据类
- **实现** 自动密码认证流程，减少手动输入
- **优化** 密码验证逻辑，支持多种登录成功检测方式
- **增强** 配置加载，自动读取密码配置信息

#### 连接验证逻辑优化
- **简化** relay就绪检测，仅依据bash提示符快速判断
- **移除** 不必要的验证命令执行，提高连接效率
- **优化** 目标服务器连接验证，支持多种环境检测
- **改进** 错误处理，提供更准确的连接状态反馈

### 💡 技术改进

#### 配置管理优化
- **增强** `_connect_via_relay` 方法，支持自动化二级SSH连接
- **新增** `_verify_target_server_connection_with_password` 方法
- **优化** 配置传递，确保target配置包含用户名信息
- **改进** 错误信息，去除敏感提示信息

#### 连接流程改进
- **实现** 完整的script-based连接流程
- **支持** 自动化密码输入和验证
- **优化** 多级连接的状态检测
- **增强** 连接超时和重试逻辑

### 🎯 使用体验提升

#### 自动化程度提高
- **无需手动** 执行二级SSH连接命令
- **自动处理** 密码认证流程
- **智能检测** 连接状态和环境切换
- **简化操作** 一键完成复杂网络环境连接

#### 连接效率优化  
- **减少延迟** 移除不必要的验证步骤
- **快速判断** 基于提示符的状态检测
- **优化流程** 连接步骤更加精简高效

### 🔍 问题修复

#### 核心问题解决
- **修复** 二级跳转停留在第一级跳板机的问题
- **解决** SSH命令缺少用户名导致连接失败
- **修复** 配置传递不完整导致的自动化失效
- **解决** 连接验证逻辑过于复杂的效率问题

### 📚 代码质量提升

#### 敏感信息清理
- **移除** 特定厂商相关的提示信息
- **通用化** 错误检测逻辑，提高代码可移植性
- **标准化** 用户名检测，支持动态配置
- **优化** 日志输出，去除敏感服务器信息

---

## v0.8.0 - BOS集成和智能Shell配置 (2024-12-19)

### 🎆 重大新功能

#### ☁️ BOS(百度云存储)集成
- **新增** 完整的BOS配置管理系统
- **自动配置** BOS凭据和访问权限
- **一键下载** 云端配置文件到Docker容器
- **智能集成** 仅在选择zsh时显示BOS配置选项
- **错误处理** 完善的BOS连接和下载错误处理

#### 🐚 智能Shell配置系统
- **Shell选择** 支持bash/zsh选择，默认bash
- **环境预检测** 智能检测是否已在目标环境中
- **自动回退** 支持首选shell和备用shell的自动切换
- **配置同步** zsh环境自动下载和应用配置文件

#### 🐳 Docker环境增强
- **完整的Docker配置管理器** (`docker_config_manager.py`)
- **模板化配置** 支持开发、ML、Web等多种模板
- **GPU支持** 完整的CUDA环境配置
- **资源管理** 内存、共享内存、端口映射等
- **自动化初始化** 容器创建后自动执行初始化命令

### 🔧 技术改进

#### 配置管理优化
- **修复** 配置文件覆盖问题，现在正确合并配置
- **增强** 连接类型显示，正确区分SSH直连和Relay中继
- **改进** SSH错误检测，提供准确的错误信息和解决方案

#### 连接稳定性提升
- **智能重连** 避免不必要的重复连接
- **状态检测** 实时检测连接和环境状态
- **错误恢复** 自动处理常见连接问题

### 📚 文档和发布

#### 新增文档
- **BOS功能进展报告** (`BOS_PROGRESS.md`) - 详细记录BOS集成功能
- **更新README** 添加最新功能介绍和使用指南

#### NPM包发布优化
- **自动化发布脚本** (`scripts/publish.js`) - 完整的发布流程管理
- **版本管理** 支持patch/minor/major版本更新
- **质量检查** 发布前自动检查文件和运行测试
- **Git集成** 自动创建标签和推送到远程仓库

### 🎆 使用体验提升

#### 简化配置流程
```bash
# 新的Docker配置流程
python3 docker_config_manager.py
# 选择模板 -> 输入基本信息 -> 自动生成配置
```

#### 智能化连接
- **环境检测** 自动检测是否已在目标环境，避免重复连接
- **Shell适配** 根据配置自动选择合适的shell
- **配置同步** zsh环境自动下载和应用BOS配置文件

### 🔄 迁移指南

#### 现有用户
- ✅ **无需操作** - 现有配置自动兼容
- 🚀 **可选升级** - 使用新的Docker配置管理器
- ☁️ **BOS集成** - 为zsh环境添加BOS配置

#### 新用户
- 🎯 **推荐路径** - 使用 `python3 docker_config_manager.py` 创建Docker环境
- 📚 **学习资源** - 阅读BOS功能进展报告
- 💡 **最佳实践** - 遵循文档中的建议

---

## v2.0.0 - 智能化用户体验升级 (2024-12-19)

### 🚀 重大新功能

#### 交互式配置系统
- **新增** `config-helper.py` - 智能配置助手工具
- **新增** `interactive_config.py` - 完整的配置管理系统
- **支持** 多种服务器类型的快速配置向导
- **支持** 可视化配置管理界面（增删改查）
- **支持** 配置导入导出功能

#### 智能用户引导系统
- **新增** `enhanced_ssh_manager.py` - 增强版SSH管理器
- **新增** `InteractiveGuide` 类 - 智能交互引导
- **自动检测** 连接过程中的用户输入需求
- **智能等待** 用户输入完成并自动继续流程
- **支持** 密码、指纹确认、2FA等多种输入类型

### 🛠️ 功能增强

#### 配置管理
- **改进** 配置文件结构和位置管理
- **新增** 实时配置验证和格式检查
- **新增** 配置预览功能
- **新增** 一键连接测试

#### 调试和故障排除
- **新增** 智能故障诊断系统
- **改进** 错误信息和解决方案提示
- **新增** 配置助手调试命令
- **新增** 紧急恢复流程

#### 文档体系
- **新增** [交互式配置使用指南](./INTERACTIVE_CONFIG_GUIDE.md)
- **全面更新** README.md 使用文档
- **新增** 完整的使用流程和示例
- **改进** 故障排除指南

### 🎯 用户体验改进

#### 零学习成本
- **消除** 手动编写YAML配置的需求
- **提供** 智能配置向导
- **支持** 多种常见服务器类型模板

#### 智能化操作
- **自动化** 连接过程中的用户交互
- **智能化** 状态检测和流程控制
- **可视化** 配置管理和操作反馈

#### 可靠性提升
- **增强** 连接稳定性和错误处理
- **改进** 会话管理和状态监控
- **新增** 自动恢复机制

### 📦 技术改进

#### 代码结构
- **重构** SSH连接管理逻辑
- **新增** 模块化的配置管理系统
- **改进** 错误处理和日志记录

#### 兼容性
- **保持** 向后兼容现有配置
- **支持** 平滑升级路径
- **无需** 额外依赖安装

### 🔧 使用方法更新

#### 新的推荐工作流程
```bash
# 1. 交互式配置（首次使用）
python3 config-helper.py --quick

# 2. 在Cursor中使用
"连接到cpu-221"

# 3. 智能引导处理用户输入（自动）
```

#### 新的调试命令
```bash
# 配置管理
python3 config-helper.py --list
python3 config-helper.py --test server-name

# 故障排除
python3 config-helper.py
```

### 📚 文档更新

- **全面重写** README.md 使用文档
- **新增** 交互式配置详细指南
- **更新** 故障排除和调试方法
- **添加** 最佳实践建议

### 🔄 迁移指南

#### 现有用户
- ✅ **无需操作** - 现有配置自动兼容
- 🚀 **可选升级** - 使用新的交互式配置管理现有服务器
- 📖 **建议阅读** - 查看新功能使用指南

#### 新用户
- 🎯 **推荐路径** - 直接使用 `python3 config-helper.py --quick`
- 📖 **学习资源** - 阅读交互式配置使用指南
- 💡 **最佳实践** - 遵循文档中的建议

---

## v1.x - 基础功能版本

### 核心功能
- MCP协议集成
- 基础SSH连接管理
- tmux会话管理
- Docker容器支持
- 手动YAML配置

---

## 🔮 未来计划

### v2.1 计划功能
- **Web界面** - 浏览器端配置管理
- **批量操作** - 多服务器并行管理
- **监控面板** - 服务器状态实时监控
- **插件系统** - 支持自定义扩展

### v2.2 计划功能
- **AI助手集成** - 智能运维建议
- **自动化脚本** - 常用任务自动化
- **性能优化** - 连接速度和稳定性提升
- **移动端支持** - 移动设备管理功能

---

## 🤝 贡献

欢迎提交Issue和Pull Request来帮助改进项目！

### 贡献方向
- 🐛 Bug修复和问题报告
- ✨ 新功能建议和实现
- 📖 文档改进和翻译
- 🧪 测试用例和质量保证

## [0.7.0] - 2024-12-19

### 🚀 重大功能更新：MCP集成配置系统

#### ✨ 新增功能
- **对话式配置管理** - 用户现在可以通过Cursor对话直接配置服务器，无需手动编辑YAML文件
- **MCP集成工具** - 新增5个MCP工具支持完整的配置管理流程：
  - `interactive_config_wizard` - 交互式配置向导
  - `manage_server_config` - 服务器配置管理（增删改查）
  - `create_server_config` - 创建服务器配置
  - `diagnose_connection` - 连接诊断
- **智能配置模板** - 为SSH、Relay、Docker等不同类型服务器提供配置模板
- **实时连接测试** - 配置完成后立即验证连接可用性
- **配置导入导出** - 支持配置文件的备份和迁移

#### 🔧 技术改进
- 新增 `MCPConfigManager` 类，专门为MCP集成设计
- 完善的错误处理和用户友好的反馈信息
- 支持多种配置验证和诊断功能
- 兼容现有的SSH Manager和配置文件格式

#### 📚 文档更新
- 新增对话式配置示例和使用指南
- 更新README，突出MCP集成的优势
- 添加详细的功能演示和最佳实践

#### 🎯 用户体验提升
- **零学习成本** - 用户无需了解YAML语法或配置文件结构
- **智能引导** - 系统自动提供配置建议和模板
- **即时反馈** - 配置过程中实时验证和错误提示
- **可视化管理** - 通过对话界面管理所有服务器配置

### 📦 发布信息
- npm包自动包含所有新功能
- 向后兼容现有配置文件
- 支持从命令行工具平滑迁移到MCP集成模式

---

## [0.6.4] - 2024-12-18

### 🛡️ 重要修复 - 配置文件持久性问题
- **修复配置文件时而存在时而消失的问题** - 这是一个严重的数据丢失问题
- **根本原因**: 多个MCP服务器进程并发访问配置文件 + 初始化逻辑缺陷
- **解决方案**:
  - 修复`has_user_config()`方法，正确检测用户配置（之前总是返回False）
  - 修复`ensure_config_exists()`方法，添加多重保护防线
  - 修复`__init__`方法，避免初始化时无条件创建目录和模板
  - 修复`ensure_directories()`方法，只在真正需要时创建模板

### 🔧 技术改进
- **超级保护机制**: 
  - 第一道防线：文件存在直接返回，绝不覆盖
  - 第二道防线：智能检测用户配置
  - 第三道防线：检查备份文件
  - 第四道防线：创建前再次确认文件不存在
- **智能配置检测**: 检测非example-server服务器、修改过的配置、自定义全局设置
- **并发访问保护**: 文件锁机制防止多进程冲突
- **配置备份机制**: 自动检测和保护备份配置

### 🧪 测试保障
- **新增回归测试套件**: `tests/regression/test_config_persistence_fix.py`
- **10个测试用例**覆盖：
  - 现有文件保护
  - 用户配置检测
  - 备份文件检测
  - 并发访问保护
  - YAML错误处理
  - 文件修改时间保护
  - 多重保护层级
  - 空服务器处理
  - 创建默认配置保护
- **所有测试通过**，确保修复稳定可靠

### 📋 用户影响
- **数据安全**: 用户配置不会再被意外覆盖或丢失
- **向后兼容**: 完全兼容现有配置文件格式
- **透明修复**: 用户无需手动操作，自动生效

### 🐛 已知问题解决
- ✅ 配置文件时而存在时而消失
- ✅ 用户配置被默认模板覆盖
- ✅ 多进程并发访问导致的配置丢失
- ✅ 初始化时无条件创建模板文件

---

## [0.13.12] - 2025-06-18

### 🔧 Relay连接配置修复
- **单级跳板配置修复**: 现在只需配置一个目标服务器，不再错误要求配置两个服务器
- **二级跳板连接顺序修正**: 修复连接顺序理解错误
  - 正确顺序：本地 → relay-cli → szzj-isa-ai-peking-poc06.szzj → 10.129.130.222
  - 之前错误理解为：本地 → relay-cli → 10.129.130.222 → szzj-isa-ai-peking-poc06.szzj

### ✨ 配置编辑增强
- **智能架构检测**: 自动识别单级/二级跳板配置
- **配置验证改进**: 更准确的relay配置验证逻辑
- **用户体验优化**: 减少不必要的配置步骤

### 🧪 回归测试套件
- **新增测试文件**: `tests/regression/test_relay_config_fix.py`
- **6个测试用例**覆盖：
  - 单级跳板配置（只需一个服务器）
  - 二级跳板配置（正确连接顺序）
  - 向后兼容性（现有配置不受影响）
  - Docker配置保护（编辑时保持Docker设置）
  - 配置验证逻辑
  - 错误处理机制

### 📦 发布信息
- **GitHub**: 成功发布到GitHub仓库
- **npm**: 发布到npm注册表 `@xuyehua/remote-terminal-mcp@0.13.12`
- **测试状态**: 39个测试全部通过

---

## [0.13.11] - 2025-06-17